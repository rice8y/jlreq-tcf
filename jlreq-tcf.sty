%%
%% This is file `jlreq-tcf.sty'
%%
%% A LaTeX package providing two-column footnotes
%% compatible with the jlreq class.
%%
%% Features:
%%  - \footnoteL{...}, \footnoteR{...} : Mark + Text
%%  - \footnotemarkL, \footnotemarkR   : Mark only (increments counter)
%%  - \footnotetextL, \footnotetextR   : Text only (fills footnote list)
%%
%% Author: Eito Yoneyama
%% Created: 2026/01/08
%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{jlreq-tcf}[2026/01/08 v0.2.0 Two-column footnotes with jlreq compatibility]
\RequirePackage{etoolbox}

\makeatletter

% ------------------------------------------------------------
% jlreq fallback / parameters
% ------------------------------------------------------------
\@ifclassloaded{jlreq}{
  \providecommand{\jlreq@zw}{1zw}
  \providecommand{\jlreq@zh}{1zh}
  \providecommand{\jlreq@omotekeiwidth}{0.12mm}
  \providecommand{\jlreq@footnote@rulewidth}{0.333\columnwidth}
}{
  \providecommand{\jlreq@zw}{1zw}
  \providecommand{\jlreq@zh}{1zh}
  \providecommand{\jlreq@omotekeiwidth}{0.12mm}
  \providecommand{\jlreq@footnote@rulewidth}{0.333\columnwidth}

  \setlength{\skip\footins}{%
    \dimexpr\baselineskip - 1\jlreq@zh\relax plus 1\jlreq@zh
  }

  \begingroup
    \footnotesize
    \edef\jlreq@do{%
      \unexpanded{\setlength{\footnotesep}}{\the\dimexpr .7\baselineskip\relax}%
      \unexpanded{\def\footnoterule}{%
        \unexpanded{\hrule width \jlreq@footnote@rulewidth height \jlreq@omotekeiwidth}%
        \noexpand\kern\the\dimexpr 1.5\baselineskip - 1\jlreq@zh\relax
      }%
    }
  \expandafter\endgroup
  \jlreq@do
}

\providecommand{\inhibitglue}{}

% ------------------------------------------------------------
% counters / storage
% ------------------------------------------------------------
\newtoks\footnotescolL
\newtoks\footnotescolR
\newcounter{footnotecolL}
\newcounter{footnotecolR}
\newcounter{twocolfootnote}
\setcounter{twocolfootnote}{0}

% ------------------------------------------------------------
% footnote mark format
% ------------------------------------------------------------
\@ifclassloaded{jlreq}{
  \if@tate
    \renewcommand{\thetwocolfootnote}{%
      \jlreq@open@bracket@before@space\inhibitglue（\tatechuyoko*{\@arabic\c@twocolfootnote}）\inhibitglue
    }
  \else
    \renewcommand{\thetwocolfootnote}{%
      \arabic{twocolfootnote}\hbox{}）\inhibitglue
    }
  \fi
}{
  \renewcommand{\thetwocolfootnote}{%
    \arabic{twocolfootnote}\hbox{}）\inhibitglue
  }
}

% ------------------------------------------------------------
% Internal Formatter (mimics jlreq's \@makefntext)
% ------------------------------------------------------------
\newcommand{\@makefntext@jlreq}[2]{%
  \reset@font\footnotesize
  \parskip=0pt
  \parindent=1\jlreq@zw

  \@tempdima=\dimexpr\columnwidth - 1\jlreq@zw\relax
  \@tempdimb=1\jlreq@zw
  \divide\@tempdima by \@tempdimb
  \multiply\@tempdima by \@tempdimb
  
  \@tempdimc=\dimexpr\columnwidth - \@tempdima - 0.0001pt\relax

  \setlength{\leftskip}{\dimexpr\@tempdimc + 1\jlreq@zw\relax}%
  
  \noindent
  \hskip -1\jlreq@zw
  \ifdefined\jlreq@referencemark@format
    \hbox{\jlreq@referencemark@format{#1}}%
  \else
    \hbox{#1}%
  \fi
  \hskip 1\jlreq@zw
  #2%
  \par
}

% ------------------------------------------------------------
% Internal List Adder
% ------------------------------------------------------------
\newcommand{\@addfootnotetolist}[3]{%
  \ifnum#1=1\relax
    \stepcounter{footnotecolL}%
    \begingroup
      \toks@={\rule\z@\footnotesep\ignorespaces#3\@finalstrut\strutbox}%
      \edef\@tempfootnote{%
        \noexpand\begingroup
          \noexpand\def\noexpand\@thefnmark{#2}%
          \noexpand\@makefntext@jlreq{#2}{\unexpanded\expandafter{\the\toks@}}%
          \noexpand\par
        \noexpand\endgroup
      }%
      \global\footnotescolL=\expandafter{%
        \the\expandafter\footnotescolL\@tempfootnote
      }%
    \endgroup
  \else
    \stepcounter{footnotecolR}%
    \begingroup
      \toks@={\rule\z@\footnotesep\ignorespaces#3\@finalstrut\strutbox}%
      \edef\@tempfootnote{%
        \noexpand\begingroup
          \noexpand\def\noexpand\@thefnmark{#2}%
          \noexpand\@makefntext@jlreq{#2}{\unexpanded\expandafter{\the\toks@}}%
          \noexpand\par
        \noexpand\endgroup
      }%
      \global\footnotescolR=\expandafter{%
        \the\expandafter\footnotescolR\@tempfootnote
      }%
    \endgroup
  \fi
}

% ------------------------------------------------------------
% Public Interface: Mark Only
% ------------------------------------------------------------
\newcommand{\@printtwocolmark}[1]{%
  \begingroup
    \protected@edef\@currentfnmark{#1}%
    \@ifclassloaded{jlreq}{%
      \jlreq@hook@prenote
      \jlreq@notemark{\@currentfnmark}%
      \jlreq@hook@postnote
    }{%
      \@textsuperscript{\normalfont\@currentfnmark}%
    }%
  \endgroup
}

\newcommand{\footnotemarkcol}[1][]{%
  \ifx\relax#1\relax
    \stepcounter{twocolfootnote}%
    \protected@edef\@tempa{\thetwocolfootnote}%
  \else
    \begingroup
      \c@twocolfootnote=#1\relax
      \protected@edef\@tempa{\thetwocolfootnote}%
      \global\let\ftc@global@mark\@tempa
    \endgroup
    \let\@tempa\ftc@global@mark
  \fi
  \@printtwocolmark{\@tempa}%
}
\newcommand{\footnotemarkL}{\footnotemarkcol}
\newcommand{\footnotemarkR}{\footnotemarkcol}

% ------------------------------------------------------------
% Public Interface: Text Only
% ------------------------------------------------------------
\newcommand{\@footnotetextcol}[3]{%
  \begingroup
    \ifx\relax#2\relax
      \protected@edef\@tempa{\thetwocolfootnote}%
    \else
      \begingroup
        \c@twocolfootnote=#2\relax
        \protected@edef\@tempb{\thetwocolfootnote}%
        \global\let\ftc@global@mark\@tempb
      \endgroup
      \let\@tempa\ftc@global@mark
    \fi
    \@addfootnotetolist{#1}{\@tempa}{#3}%
  \endgroup
}

\newcommand{\footnotetextL}[2][]{\@footnotetextcol{1}{#1}{#2}}
\newcommand{\footnotetextR}[2][]{\@footnotetextcol{2}{#1}{#2}}

% ------------------------------------------------------------
% Public Interface: Footnote
% ------------------------------------------------------------
\newcommand{\footnotecol}[2][1]{%
  \footnotemarkcol%
  \@footnotetextcol{#1}{}{#2}%
}

\newcommand{\footnoteL}[1]{\footnotecol[1]{#1}}
\newcommand{\footnoteR}[1]{\footnotecol[2]{#1}}

% ------------------------------------------------------------
% Output Routine
% ------------------------------------------------------------
\newcommand{\printtwocolumnfootnotes}{%
  \ifnum\numexpr\value{footnotecolL}+\value{footnotecolR}>0\relax
    \par
    \begingroup
      \reset@font\footnotesize
      \vskip\skip\footins
      \footnoterule
      \dimen@=\dimexpr(\textwidth - \columnsep) / 2\relax
      
      \nointerlineskip
      \noindent
      \begin{minipage}[t]{\dimen@}
        \footnotesize
        \setlength{\parskip}{0pt}%
        \ifdefined\jlreq@zh
          \setlength\lineskip{.1\jlreq@zh}%
          \setlength\normallineskip{.1\jlreq@zh}%
        \fi
        \sloppy
        \the\footnotescolL
      \end{minipage}%
      \hfill
      \begin{minipage}[t]{\dimen@}
        \footnotesize
        \setlength{\parskip}{0pt}%
        \ifdefined\jlreq@zh
          \setlength\lineskip{.1\jlreq@zh}%
          \setlength\normallineskip{.1\jlreq@zh}%
        \fi
        \sloppy
        \the\footnotescolR
      \end{minipage}
    \endgroup
    \par

    \global\footnotescolL={}%
    \global\footnotescolR={}%
    \setcounter{footnotecolL}{0}%
    \setcounter{footnotecolR}{0}%
    \setcounter{twocolfootnote}{0}%
  \fi
}

% ------------------------------------------------------------
% Hooks
% ------------------------------------------------------------
\newcommand{\@insertfootnotes}{%
  \ifnum\numexpr\value{footnotecolL}+\value{footnotecolR}>0\relax
    \par\vspace*{\fill}
    \printtwocolumnfootnotes
  \fi
}

\let\@oldclearpage\clearpage
\renewcommand{\clearpage}{%
  \@insertfootnotes
  \@oldclearpage
}
\let\@oldnewpage\newpage
\renewcommand{\newpage}{%
  \@insertfootnotes
  \@oldnewpage
}

\AtEndDocument{\@insertfootnotes}

\makeatother
\endinput